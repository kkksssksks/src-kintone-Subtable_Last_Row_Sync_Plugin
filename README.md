# 🧩 kintone サブテーブル最下行転記プラグイン
**Subtable Last Row Sync Plugin for kintone**

kintoneのサブテーブル（明細）に入力された **「一番下の行（最新行）」** の値を、レコード内の指定したメインフィールドへ自動的に同期・転記するプラグインです。

サブテーブルの履歴を残しつつ、「最新のステータス」や「最終対応日」を一覧画面で確認したい場合に最適です。

---

## 🚀 主な機能 (Key Features)

### 1. リアルタイム同期 & 完全自動化
* **即時反映**: サブテーブルへの入力、行追加、行削除の操作に合わせて、瞬時にメインフィールドへ値を同期します。
* **スマホ対応 (v1.2~)**: kintone モバイルアプリからの入力・保存にも完全対応しています 📱。
* **フィールドロック**: データの整合性を保つため、転記先に設定されたフィールドは自動的に「編集不可」になり、誤入力を防ぎます 🔒。

### 2. 強力な一括更新機能
* **既存データも安心**: すでにデータが入っているアプリでも、一覧画面のボタン一つで全レコードを最新状態に同期できます。
* **大量データ対応**: 数千件規模のデータでも安定して動作します。
* **フェイルセーフ設計**: 更新中にエラーが発生しても、そのレコードをスキップして処理を継続。終了後には詳細なエラーログを画面に表示します 🐞。

### 3. 安全で使いやすい設定画面
* **直感的な操作**: ドラッグ＆ドロップでフィールドの並び順を変更できます ↕️。
* **設定ミス防止**: 同じテーブルや同じフィールドを重複して選べないよう、システムが自動で制御します 🛡️。
* **多言語対応**: ユーザーの言語設定に合わせて、日本語/英語の表示を自動で切り替えます 🌐。

---

## 📊 仕様・対応フィールド

### 転記タイミングについて
kintoneのAPI仕様により、フィールドタイプによって同期されるタイミングが異なります。
※「即時」に対応しているフィールドは、データの整合性を保つため**保存時にも再同期**されます。

| フィールドタイプ | 転記タイミング | 備考 |
| :--- | :--- | :--- |
| **文字列（1行）** | ⚡️ **即時** + 💾 **保存時** | カーソルを外した瞬間、および保存時に転記されます。 |
| **数値** | ⚡️ **即時** + 💾 **保存時** | カーソルを外した瞬間、および保存時に転記されます。 |
| **ドロップダウン** | ⚡️ **即時** + 💾 **保存時** | 選択肢を変更した瞬間、および保存時に転記されます。 |
| **ラジオボタン** | ⚡️ **即時** + 💾 **保存時** | 選択肢を変更した瞬間、および保存時に転記されます。 |
| **チェックボックス** | ⚡️ **即時** + 💾 **保存時** | チェックを変更した瞬間、および保存時に転記されます。 |
| **複数選択** | ⚡️ **即時** + 💾 **保存時** | 選択を変更した瞬間、および保存時に転記されます。 |
| **ユーザー選択** | ⚡️ **即時** + 💾 **保存時** | ユーザーを選択した瞬間、および保存時に転記されます。 |
| **組織選択** | ⚡️ **即時** + 💾 **保存時** | 組織を選択した瞬間、および保存時に転記されます。 |
| **グループ選択** | ⚡️ **即時** + 💾 **保存時** | グループを選択した瞬間、および保存時に転記されます。 |
| **日付 / 時刻 / 日時** | ⚡️ **即時** + 💾 **保存時** | 値を入力・選択した瞬間、および保存時に転記されます。 |
| **ルックアップ (コピー元)**| ⚡️ **即時** + 💾 **保存時** | 「取得」で値が入った瞬間に転記されます。 |
| **文字列（複数行）** | 💾 **保存時のみ** | kintoneの仕様上、保存ボタン押下時にまとめて転記されます。 |
| **リッチエディター** | 💾 **保存時のみ** | kintoneの仕様上、保存ボタン押下時にまとめて転記されます。 |
| **リンク** (URL等) | 💾 **保存時のみ** | kintoneの仕様上、保存ボタン押下時にまとめて転記されます。 |

### ❌ 非対応・制限事項
以下のフィールドは、本プラグインの「転記先（コピー先）」として指定できません。

* **添付ファイル**: 技術的な制約により非対応です。
* **計算**: 自動計算フィールドには値を書き込めません。
* **ルックアップ (コピー先)**: 転記自体は可能ですが、「編集不可（ロック）」機能が働きません（kintoneの仕様上、手動取得が必要なため）。
* **関連レコード一覧 / プロセス管理 / カテゴリーなど**: 値を持たない、または書き込み不可のフィールド。

---

## 🛠 インストールと設定方法

### 1. プラグインのインストール
1. リリースページから `Subtable_Last_Row_Sync_Plugin.zip` をダウンロードします。
2. kintoneシステム管理 > プラグイン > 読み込み からzipファイルをアップロードします。
3. 利用したいアプリの設定 > プラグイン > 追加 から本プラグインを追加します。

### 2. プラグインの設定
1. プラグインの設定（歯車アイコン）を開きます。
2. **「＋ テーブル設定を追加」** をクリックします。
3. **対象テーブル**を選択します。
4. **「＋ フィールドペアを追加」** をクリックし、以下を設定します。
    * **コピー元**: サブテーブル内のフィールド
    * **コピー先**: フォーム上のフィールド（メインのフィールド）
5. 必要に応じてペアを追加し、**「設定を保存する」** をクリックします。

> **💡 ヒント**: コピー先のフィールドは、コピー元の値を受け取れる型（例: 文字列1行など）を用意してください。「文字列（1行）」フィールドであれば、ほとんどの型の値を受け取れます。

---

## 💻 技術情報 (For Developers)

本プラグインは、エンタープライズ利用を想定し、**Cybozu セキュアコーディングガイドライン** に準拠して開発されています。

* **No jQuery**: jQueryなどの外部ライブラリを一切使用せず、**Vanilla JS** (標準JavaScript) のみで記述されています。ライブラリのバージョン競合や脆弱性のリスクがありません。
* **XSS対策**: `innerHTML` の使用を排除し、セキュアなDOM操作メソッド（`createElement`, `textContent`）を使用しています。
* **競合排除**: 設定画面および実行ロジックにおいて、設定の重複によるデータ競合が発生しないようバリデーションを実装しています。

---

## 🔄 更新履歴 (Changelog)

| バージョン | 公開日 | 更新内容 |
| :--- | :--- | :--- |
| **v1.2.1** | 2026/02/09 | **【不具合修正】**<br>・計算フィールド等のエラー値（`#N/A!`）がそのまま転記される問題を修正。エラー時は「空」として扱うよう改善。 |
| **v1.2** 🚀 | 2026/01/31 | **【メジャーアップデート】**<br>・**モバイル対応**: kintoneスマホアプリでの動作を完全サポート 📱<br>・**多言語対応**: 日本語・英語のUIローカライズ (i18n) 🌐<br>・**ログ強化**: 一括更新時のエラー詳細表示機能を追加 🐞<br>・**UI改善**: 設定画面でのドラッグ＆ドロップ並べ替え機能を追加 ↕️<br>・**バグ修正**: 設定画面のドロップダウン初期化処理を修正 |
| **v1.1.3** 🛡️ | 2026/01/31 | **【セキュリティ＆信頼性強化】**<br>・**セキュアコーディング準拠**: `innerHTML`を廃止し、セキュアなDOM構築へ刷新。<br>・**ライブラリ依存排除**: jQueryを廃止し、Vanilla JSへ完全移行。<br>・**設定ミス防止**: 転記先フィールドの重複選択を防止する動的制御を追加。<br>・**バグ修正**: 設定保存後の遷移先URLを修正。 |
| **v1.1.2** | 2026/01/31 | **【安定性向上】**<br>・設定画面で同じサブテーブルを重複して選択できないよう制限を追加。<br>・一括更新時に発生していたJSONエラーの修正。<br>・「未選択」状態への同期が正しく反映されないバグを修正。 |
| **v1.1.1** | 2026/01/29 | **【バグ修正】**<br>・サブテーブルを空にした際にコピー先がクリアされない不備を修正。 |
| **v1.1.0** ✨ | 2026/01/26 | **【機能追加】**<br>・一覧画面への「一括反映ボタン」および進捗表示機能（プログレスバー）を追加。<br>・フェイルセーフ実装: エラー発生時にスキップして継続する機能。 |
| **v1.0.0** | 2025/12/25 | **【初期リリース】**<br>・サブテーブル最下行の自動転記機能。<br>・フィールドの編集ロック機能。 |

---

**License**: MIT